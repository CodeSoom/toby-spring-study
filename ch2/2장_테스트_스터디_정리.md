# 2장 테스트 (토비님 이야기 정리)
테스트를 왜 만들어야 하는지에 대해 논쟁을 겪을 수 있다.
`당연히 해야 하는 거 아냐 ? 기본 아니야 ?`
테스트를 열심히 하는 사람은 한 번씩 가지게 되는 고민인 것 같다.
그런 생각을 하면서 왜 필요하지 ? 생각을 해야 한다.

`켄트백` 의 `TDD(테스트 주도 개발)` 책을 보면 후반부에 `학습 테스트`를 소개하는 내용이 나온다.
**학습테스트 ! (한 번 해볼 것)**

### (망규 님)
2장을 읽다보니 `테스트가 없었을 떄 어떻게 검증을 했었는가 ?` 에 대한 생각이 들었고,
B-to-B 에서 테스트는 하나의 문서화가 될 수 있다는 것이 장점이다.
의미있는 테스트를 어떻게 작성할 수 있는가를 생각하게 한다.

### (토비 님)
`네거티브 테스트` 를 우선적으로 만드는 게 좋다고 생각한다.
이전에는 JUnit 테스트는 왜 public 으로만 만들어야 했는가 ?
원래 설계에서의 JUnit 은 클래스 하나에 테스트 메서드 하나만 만들어야 했다.
→ 이러다가 비슷한 테스트를 클래스 하나에 밀어 넣게 되었다. utility 등 ~?

소문자 test 로 시작하는 메서드는 테스트 메서드이다.
이것을 실행하는 프레임워크가 reflection 을 이용해서 테스트라고 시작하는지 찾아야 했는데 ~ (중간 생략, 다음 구문이 이해가 빠름)

```
JUnit이 처음 만들어지던 때 사용했던 JDK1.1 에서는 리플렉션에서 public 메소드만 접근을 허용했습니다. 
따라서 JUnit의 테스트 메소드는 모두 public 일 수 밖에 없었습니다. 그게 관례가 되서 지금까지 내려온 것입니다.
```

JUnit 4 의 prefix 를 이용한 방식에서 → JUnit 5 @test 를 읽는 방식으로 바뀌었다.
public 으로 만들었던 전통이 있어서 junit 5 는 거의 새롭게 만든 프레임워크이다.
그러나 private 으로 만들거나 그러라는건 아니고 타이핑하기 편하게 default 그냥 만들면 된다.
public 을 굳이 만들어서 붙이는 분들이 계시는데 옛날부터 쓰셔서 그러신가보다 라고 생각하면 된다. ex) 김영한 님

# 테스트 시간 ? 
수행 시간을 빨리 돌려야 한다 이건 다음에 얘기를 더 해보도록 하자.
테스트를 만들어야 한다는 개념이 폭력적으로 나타날 때는 2007-8 즈음이었다.
테스트 돌리는 동안 멍하니 보고만 있으면 잔소리를 했다. ex) 테스트 돌아가는 중에 다음 테스트를 위한 코드를 짜야지 왜 멍하니 보고만 있나

## 라이브 테스트 ? 
켄트 백이 junit 백이라는 이클립스 플러그인 만들었다.
테스트를 작성하고 있으면 백그라운드에서 테스트를 계속 실행하고 있다. 테스트 작성 도중에 틀린 내용을 계속 보여준다.
자바는 프레임워크 하나만 남아있는듯 ? 닷넷에서는 고급버전에서만 되는 것으로 알고 있음

해당 플러그인이 발전 못하는 이유 ? 2-3 돌리는 동안 커피 한잔 하고, 트위터도 좀 하고 이게 낙이어서 그런듯하다.
전체 테스트를 돌려놓고 sns 를 하는 분도 있는 것 같다.
테스트 돌려놓고 잘 작업할 수 있다. (토비님 생각)

### (토비님)
테스트 코드 작성하는 것을 처음 알게된 게 2003년 Jboss 에서 알게 됐다. 오픈 소스 ejb webserver 이런거 고도화된 서버였는데 소스 코드를 받아서 보다 보니깐 테스트 폴더가 있더라.
실제 서버가 띄워지는 것을 테스트 하는 것을 보면서 (거의 2시간 걸렸다) 희열을 느꼈다. `와 이런게 가능하구나.`
ui 가 있는 화면을 레코딩하면서 기능을 테스트해 보는 (툴을 써서) - 워낙 잘 안됨 (예전에는 이런식의 테스트가 있었음)
코드로 테스트를 할 수 있다는 것을 보면서 너무 놀랐다.

전세계 사람들이 JUnit → TDD 에 빠졌다. 2006 ~ 2010년 전세계에서 테스트 작성 뭉뚱그려 가지고 테스트를 한번도 작성해 보지 못한 사람에게 `테스트 작성해 보세요` 가 들어갔고, 커버리지 몇 십프로 채우지 않으면 인사고과 점수가 낮게 나오던 시절이 있었다.
한국은 한발 늦게 이런 시기가 왔지만, 아무튼 세계적으로 이런 시절이 있었다.

**그러다 테스트 회의론에 빠졌다.**
해외에 합리적으로 일한다는 회사에서 `오늘도 회사에서 요구하는 커버리지를 채우기 위해 아무 의미도 없는 테스트를 작성하는 나를 보면서 환멸을 느낀다` 라는 글을 작성하는 사람이 생겼다.
한쪽에서는 TDD 테스트 작성에 환호를 했고, 한쪽에서는 이런 반응이 있었다.

인포큐 ??? 에서는 일주일에 적어도 한 번은 테스트에 대한 글이 올라 왔었을 정도로 테스트 부흥기가 있었는데, 
2011 ~ 2012 년 즈음에 TDD 테스트 작성 얘기가 싹 사라졌다. (이때를 암흑기라 표현하심)
책이 나오는 즈음에 과도하게 열광하는 사람들, 푸쉬하는 사람들, 테스트를 해봤는데 생산성 떨어져서 절망(?)에 빠진 사람들이 있었다.
(그러나 토비 님은 그 시절에) `당연히 테스트를 해야 한다` 고 얘기를 하고 다녔다. 

그리고 나서 테스트 작성에 대한 관점이 서서히 새로 입문하시는 개발자들부터 시작해서, 모든 기술은 나오면 테스트를 작성하는 법부터 시작을 하고, 모든 언어에 테스트를 적용하고, 오픈 소스에도 테스트를 적용하는 등 테스트의 개념이 서서히 자리를 잡아 나가기 시작했다.
그러나 그 시절의 당연히 `테스트는 작성해야 한다` 까지는 못온 것 같다.

그 사이에 테스트에 가볍게 접근하고 JUnit 으로 작성하는 것과 TDD 로 작성하는 것 구분 못하는 사람 많다.
테스트 코드 작성과 TDD 작성이 구분되지 않은채 퍼졌었다. (많이 퍼지던 시기에)
사람들이 열광헀다 → 실망 → 다시 테스트를 작성하기 시작하는 싸이클을 보면서 테스트에 대한 생각과 느낀점이 많다.
이 책을 쓰던 시절에는 한번이라도 테스트를 작성하면 좋겠다는 생각에 책을 썼다.

스프링 이전에는 테스트 만들기가 너무 어려웠다. (비싼 툴)
Junit, TDD 서버 어플리케이션 테스트 하려면 너무 어려웠다.
스프링 많은 부분에서 지원하려고 노력을 많이 함.
DI 콜라보레이터를 Mock, 좋다.

테스트 코드를 하나 돌렸더니 모든 게 다 돌아가는 ~ ?? 디버그 ???
테스트 더블 ???? ????? Test Double 
스턴트 더블(Stunt double)
스턴트를 하면서 다른 사람인 척 하면서 끼어들어 하는 거 ??? 테스트 대역 ???
stuck, mock, spy, dummy, fake → **Imposter ?** (토비 님은 이 단어가 적절하지 아니한가 의견을 제시하셨다)

테스트 대역 이라는 어려운 언어 쓰지 말고 `임포스터` 가 어떤가 ? 다른 사람인척 하고 속이면서 행동을 하는 그런 사람을 임포스터라고 하니깐

### (토비 님)
테스트하기 어려운 코드는 특정 구현의 코드가 종속이 많이 되어있는 경우가 그렇다. 
느슨한 관계로 만들어주면 테스트하기 좋다.

객체지향적 설계를 따라간다고 해도 테스트하기 어려운 코드가 좋은 코드일리는 없는건 확실하다. (강한 결합도가 높은 코드일리가 분명)

**테스트 하기 쉽다 → 코드 엉망진창일 수도 있다.**
**기능을 잘 구현 못했으면 테스트 하기 아무리 쉽다고 해도 소용이 없는 거죠.**

### Q) 테스트를 위해서 비즈니스 코드를 손대는 경우 ?

A) (김진영 님) 유지보수를 하는 것이 테스트 코드까지라고 생각한다.
과도한 테스트도 있음
테스트 코드 조차도 잘 짜야 하는 코드라고 생각한다.
프로덕션 코드와 테스트 코드가 그렇게 다른가 ? 1급 시민, 2급, ~ 전 다 중요하다
명세 관련해서 스웨거를 붙이는건 안좋아하는데
테스트 코드를 위해서 deleteAll(), get() 같은 비즈니스 로직을 추가하는 건 좋았다.

A) (연로그 님) 테스트 코드 때문에 비즈니스 로직을 추가하는 것은 안좋아한다.
더 많은 로직들이 테스트 때문에 복잡해지는 상황이 생긴다.
따라서 테스트 코드 때문에 비즈니스 로직을 추가하지 말자라는 나만의 기준이 생겼다.

A) (토비 님) 복잡한 로직이 들어가지는 않겠죠. 2장에서는 db 테스트 할 수 있는 방법이 이것밖에 없다. 하지만 이거는 결국 유저를 다루는 dao 에서는 필요로하는 기능일 테니까 타협을 한 코드라고 볼 수 있다.
db 까지 건드리는 상황을 가지고 예제를 만들었다.
롤백 테스트라는 것을 한다. 테스트 동안에 디비에 쌓았으면 테스트가 끝나면 롤백을 하는 ~
dao 에 delete 가 들어가는게 이상한 것은 아닌데 그런게 없어지죠 (3장, 5장에 나옴 그런 내용) 여기는 그냥 이렇게도 테스트할 수 있습니다.

하늘이 무너지는게 아니면 해야죠. 사용할 수 있다.
`문제를 일으키는 것 같다. 지저분해진다.` 느껴지면 대안을 찾으면 됨. (예를 들어,) 쿼리를 직접 날려서 없애도 된다.
**2장 독자들의 상황과 수준을 고려해서 이렇게 책을 쓰게 됐다.**
트렌젝션 테스트 ? 트렌젝션이 잘 걸렸는지 아닌지 테스트하는게 어렵다.
롤백이 되는지를 테스트해야 하는데 예외가 발생을 하고 롤백이 되가지고 트렌젝션이 다 돌아가지 않고 이전까지 디비에 다 남아 있으면 트렌젝션 테스트 실패 아니면 트렌젝션 테스트 성공
예외를 데이터 셋팅 ?? 코드에다 이번 실행을 할 때 강제로 예외를 던져라

(뭔말이지)
트렌젝션이 잘 동작하는가 ? (뭔소리지?)
테스트 코드가 비즈니스 로직을 침범하는게 좋은 것은 아니다. ??? 결론인가???


### Q) 툴을 이용해서 테스트 작성 했는데 테스트를 위해 @MockBean, @SpyBean을 사용하는 것이 좋은 디자인이 아님에도 테스트 코드를 작성하기 편해지기 때문에 사용하지 않는 편이 좋다는 [글]([https://jojoldu.tistory.com/320](https://jojoldu.tistory.com/320)) 을 봤습니다. 이에 대한 다른 분들의 의견이 궁금합니다.

### (토비 님)
이동욱 님 글은 정확히 말하면 테스트 얘기라기 보다는 다른 경우에도 적용이 될만한건데 어떤 의견이 궁금한건지 구체적으로 얘기 좀 더 해달라

### (추가 Q)
목빈, 스파이빈을 사용하지 말자는 얘기는 아닌데
2장 직접적인 내용이 아니라서 개인적으로 고민했던 부분이라서 남겼던 글
궁금했던 거는 어떠한 툴들을 사용을 해서 정석적인 방법이 있는데 인터페이스에서 DI 주입
모키토에 given when then
어떤 방법을 사용하고 그 이유는 뭐인지 어떤게 정석적인 방법이고,
spybean 의 경우에는 외부에 라이브러리를 가져와서 쓰는
모킹하는 방법으로 사용한 적이 있는데
구현하지 않는 코드에 대해서
필요한 메서드, 필요하지 않은 메서드 ? ???
설정을 해줘야 하는 케이스가 있었고 라이브러리 ~~??
2번이랑 연관된 이야기
어떤식으로 ????? ㅇ결과를 내는지 ? 어떻게 사용을 하는지
모킹을 어떻게든 해야 하는 상황인데 컨트롤 할 수 없는 경우 직접 사용하게 할 수 없고
mock 라이브러리 ~~ ? ? **인터페이스 30개쯤 다 만들어야 하는 경우** <- 이 내용이 촛점이다.
mock 이나 stub 을 종종 이용한다 ?

### (토비 님)
이동욱 님 글은 전에 본건데, 이 글의 요지는 여러 가지 외부 라이브러리를 모킹해서 이렇게 해서 접근하는거 어렵지 않은데 내 코드에서 직접 접근해야 하는 것을 가능하게 ~ 새로운 오브젝트를 두고 모킹은 간단하게 할 수 있으니 모킹을 할 수 있었다.  (다른 이야기임)
직접 구현 ??? 쓰지 않을 것도 구현해야 하네 ??? 기계적으로 ????
어뎁터 오브젝트를 하나 만들어서 쓴다 → 내 코드가 평생 의존을 할건지 설계 고민이 중요
**aws 의 기능을 사용하는 코드가 필요하다. 비즈니스 로직 코드에서 aws 빈을 등록해서 의존하는 구조의 ~**
azure gcp 자체 클라우드 내부 서비스 이용할 수 있는데 내 코드로 바로 의존하는게 좋을까 ?
### 추상화된 계층을 넣는게 좋겠다. 이렇게 접근을 하면 괜찮은 접근법
모킹을 해서 aws 10개 중 하나만 쓰는데 목을 하고 있네 ? aws 를 계속 쓸건데 ??
중간에 뭐를 둔다 좋은건 아닌듯 ?
내가 만든 비즈니스 코드가 추상화, 외부 라이브러리 끌어오는거 로우 레벨인 경우
목빈 스파이빈 편하게 써라
리모트, 비즈니스 코드에 직접 넣지 않는게 좋다.
스프링의 레스트 템플릿, 비즈니스 코어 로직이 담긴 코드에 직접 주입하는 구조 ㄴㄴ

### 외부 api
**Mock 을 쓸 떄 주의점**
Mock 라이브러리는 런타임에 클래스 동적으로 만들어서 로딩해서 하는 복잡한 구조이다.
시간이 오래걸린다. junit 은 하나의 클래스에 테스트 메소드 10개 매번 새로운 인스턴스를 만듬
목을 사용하는 무언가를 넣으면 메소드마다 목을 새로 만들어서 ~
### 인스턴스를 테스트 클래스 한번 만들때 한번만 만들도록 하라

(???) 퍼 클래스 ?????? → 다른 기준 하나를 깨뜨리게 되는 것

### Q) 인수테스트를 할 시 `사용자 시나리오`에 맞춰 수행해야 합니다. 이때 사용자를 프론트엔드로 설정하고, 특정 API에 대한 테스트를 진행하는 방법이 있습니다. 사용자를 우리 서비스의 유저로 설정하고, 여러 API 의 상호작용에 대해 테스트를 진행할 수도 있습니다. 사용자를 어떤 층으로 정해 테스트를 하는게 좋을지 궁금합니다.

인수테스트 → 토비 님 별로 안좋아하시는 것 같다.

처음 단위 테스트라는 개념이 들어왔을 때, 혼란했다.
qa 테스트를 하시는 분들 입장에서는 단위 테스트라는 것은 기능 단위였다. **예를 들어, 회원 가입**

### 그렇다면 JUnit 에서 말하는 단위테스트는 무엇인가 ?
단위테스트는 돌아가는 동안 `db 엑세스를 하지 않는 등의 외부와 엑세스가 없어야 한다.`
더 나아가는 경우 `클래스 한개만 테스트해야` 단위 테스트다라고 말하기도 한다.
`그러나 작은 메소드 하나, 큰 경우는 회원 가입 하나`를 단위 테스트라고도 말한다. (토비 님) 난 이것도 공감한다.

db 엑세스 하면 안된다는 이유는 테스트 결과가 동일해야 한다. 독립적이어야 한다. 
(극단적으로) 100 번 1000번 똑같은 결과가 나와야 한다.
예를 들어, 테스트 순서가 54321 이던 12345 이던 결과가 다 똑같아야 한다. → 이걸 전제로 깔고 하면 어떤식으로 해도 상관 없다.

그래서 나중에는 켄트백이 `개발자 테스트` 라는 단어를 사용했다.

인수테스트 > 뭐라고 정의하느냐에 따라서 달라질듯 ?
테스트 코드로 어떻게 해보려고 했지만 시나리오가 계속 변해야 하니깐 안정성의 이유로 테스트 자동화가 힘드니깐 qa 한테 맡기는게 좋겠다. 이런 의견도 있다.

### Q) (커다란 기능을 TDD로 개발한다면) 테스트 코드를 작성할 때 하나의 기능 내부 구현을 블랙박스로 보고 외부 인터페이스를 테스트 하려는 경향이 개인적으로 있습니다. 그런데 만약 TDD를 시도하는 경우인데 내부 구현에 참여하는 모듈이 다양하고 규모가 꽤 있는 경우 테스트 코드를 작성하고 테스트를 실행하기 까지 꽤 오랜 시간이 걸리는 경우가 있는 것 같습니다. 그래서 여러가지 문제를 만납니다. 여러 모듈이 있다보니 어디서 문제가 발생했는지 알기 어렵거나 테스트를 통해 즉시 확인 받으면서 코드를 작성하지 않으니 불안함이 이어지는 것도 같습니다. 이럴 때 블랙 박스 내부 구현 모듈 하나하나를 단위테스트 코드로 더 쪼개서 작성하는 편이신가요? (질문을 정리하다 보니 이와 같은 문제가 있다면 더 작은 단위의 내부 모듈로 테스트를 분리하는 것이 좋겠다는 생각이 들긴 합니다) 외부 구현 블랙박스 내부 구현 테스트  TDD 모듈 많이 참여하고 규모가 좀 있는 경우 테스트 코드를 먼저 짜고 다 만들기 까지 텀이 길다. 어느 모듈에 문제가 있는지 ??

### (토비 님)
TDD 를 많이 하시나요 ? (개인적으로 하고 있다)
(교육을 받는 분들) TDD 를 한다. 테스트는 TDD 로 작성해야 한다 ? 그냥 그런게 있다고 들었다.

**테스트는 언제 만들어야 할까 ?** 결국은 이게 중요하다.

모듈을 하나 개발하는데 일주일 정도 시간이 지났는데 기능이 다 완성이 안됐고 TDD 로 하면은 이 상황이 개선이 될까 ?
논쟁이 많고 어려운 주제다. 
TDD 도 테스트를 작성하는 방법 중 하나라 생각한다.
테스트 작성하는 건 좋다 (모두 동감할 거고)
**얼마나 시간이 지나서 작성하는게 좋은데 ? 테스트 작성은 코드를 작성하고 나서 빨리 하는게 좋지 않은가 ?**
오늘 만든 코드는 이번주가 끝나기 전에 테스트 코드를 작성하자는 기준을 잡는 것도 괜찮다. (구글의 어떤 개발자, 금요일에 다른 일은 하지 않고 월 ~ 목요일에 만든 코드에 대한 테스트 코드를 작성)
### 고로 테스트를 빨리 만드는게 좋다. 빨리 검증하면 검증할수록 좋다.
코드를 작성하고 한 시간 이내 ? 10분 이내 ?
이런 생각을 하다 보면 어디까지 가냐면 **즉시 그 코드에 대한 피드백을 줄 수 있는 테스트 코드를 미리 작성해야 한다.** 는 생각까지 간다.
(TLP 테스트 라스트 ~ )
TDD 테스트를 먼저 작성하고 코드 ~~
시간의 문제라고 생각할 요지가 있어서 TDD 라 이름을 바꿈
빨리 받을 록 좋다. 얼마나 빨리 받는게 좋은가 ? **즉시**

### 즉시 받는 방법, 즉 미리 만들어 놓는 것이다. 따라서 극단까지 밀어붙이면 TDD 가 되는 것이다.

시간의 순서 ? 켄트백 TDD 서문에서 테스트 주도 개발은 코드를 만들면 뭘 만들지 생각하고 코드를 만들고 5분 이내에 테스트 ~ ㄴㄴ

**내가 작성한 코드의 피드백을 받는 사이클을 컨트롤 하는 기법이다. 아이디어를 생각하고 그 코드가 작성이 되고 피드백을 받는 시간의 간격을 갭이라 하는데 어떻게 조절할 수 있는지 컨트롤할 수 있는지가 TDD 이다.**
**내가 그 피드백을 받는 갭을 의식하고 컨트롤 하고 있었으면 그것을 TDD라 한다. (켄트백)**
2주 정도 계속 코딩하다가 피드백을 받아도 괜찮다. (안정감이 있으면 괜찮다)
불안함이 있으면 더 빨리 피드백을 받을 수 있는 방법을 찾아라.

블랙박스의 경계를 어디로 치느냐 결정하기 나름이 아닌가 ?
작은 모듈을 만들고 너무 덩치가 큰 모듈이 되지 않도록 나누면 피드백을 받을 수 있는 주기를 관리를 할 수 있는게 아닌가 ?
테스트를 언제 받는지는 중요하지 않다고 생각함
일주일 동안 불안감을 느낀다 ?? 나중에 테스트 어떻게 하려고 그런가 ??? (어휴 그러면 안돼요 ~~~)
작게 쪼개서 만드는게 좋다. 블랙박스 테스트가 만능은 아니다. (화이트 박스 테스트는 블랙 박스 테스트의 반대말이라고 하는데 하얀 박스는 안이 안보이니깐 글래스 박스 테스트라고 하자는 의견이 있다)

프라이빗 메소드를 테스트한다던가 외부에 공개하면 안되는 메소드를 테스트하는 것 ~??
필요하면 프라이빗 메소드도 테스트 해라. 프라이빗 메소드 체크할 수 있는 툴이 많다.
더 좋은건 설계를 잘해서 분리하는 방향도 있다.

### Q) (제한된 시간과 포괄성의 트레이드오프) 현업에서 일하다보면 늘 시간이라는 제약을 마주합니다. 제한된 시간은 포괄적이라는 개념을 완벽하게 적용할 수 없게 하는 제약이 되는데요. 현업에서 제한된 시간 안에 포괄적인 테스트를 작성하는 지혜에 대해 나누어 보고 싶습니다. 예를 들면 어떤 종류의 테스트는 이럴 때 포기하기도 한다. 어떤 종류의 테스트는 꼭 사수한다와 같은 것들이요. (질문을 하고 답변을 생각해 보니) 저는 일정이 촉박한 경우는 모든 기능의 성공케이스만 일단 테스트 케이스를 작성하고 예외 케이스는 단위 테스트를 하면서 발견되는 예외 상황만 추가로 작성하는 등의 방법을 사용하는 것 같아요.
si 프로젝트 예외 테스트를 먼저하라는 글이 있는데 성공하는 테스트 케이스 먼저 진행하고 나중에 예외 테스트를 한다.

### (토비 님)
버그가 발생하면 보완
제일 어려운 디버깅은 논리적인 버그를 잡는 일이다.
제일 쉬운 널포인트 디버깅은 exception 을 추적하기만 하면 된다. 금방 추적이 된다. 문제 해결이 쉽다.
논리적인 버그가 어려움. 프로그램 문제가 없는데 일주일에 한 번씩 틀어진다던가

포괄적인 테스트를 작성하다보면 해결되기는 한다.
정수를 입력 받는다. 입력값을 어떻게 받아야 포괄적인 테스트가 되는가 ?

균등 분할, 경계값 분할
랜덤한 값을 500번, 1000번 파라메터 값을 넣고 테스트를 하는 것 보다는
양의 정수, 음에 정수, 0 (포괄적인 세 가지 경우) 를 놓고 테스트를 하는게 낫다. 분할을 잘하면 조합을 잘하면 테스트가 짧다.

완벽함을 추구한다고 1000번이나 되는 테스트를 진행한다고 치자 랜덤한 숫자로만 테스트를 한다고 했는데 양수만 1000번이 나오는 테스트를 진행한다면 ? 음수가 들어면 꽝
경계값, 숫자를 다루는 경우 반올림 오차에서 문제 생긴다. 쌓이면 큰 잘못된 값을 만들어낸다.
경계값 주변의 작은 숫자 테스트
